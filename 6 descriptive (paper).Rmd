---
title: "Orwell paper descriptive analysis data dump"
author: "Azzah (C4C)"
date: "`r Sys.Date()`"
output:
  pdf_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r environment-data-setup, include = F}
##### PRELIMINARIES #####
# Clear console and environment 
graphics.off(); rm(list=ls());cat("\14");

# Load packages
#install.packages("pacman") # install the package if you haven't 
pacman::p_load(tidyverse,data.table,dplyr,knitr,tinytex,corrplot,stringr,summarytable,makecell,
               Hmisc,showtext,stats,pollster,sjPlot,psych,lavaan, viridis, texreg, kableExtra,
               rempsyc, effectsize, flextable, broom, report, stargazer, modelsummary, margins)

# Retrieve the current system username
current_user <- Sys.info()[["user"]]

# Check if the username matches and set the working directory accordingly
if (current_user == "User") {
  base_dir <- "H:/"
} else if (current_user %in% c("azzah", "USER")) {
  base_dir <- "G:/"
} 

# Set directory
master <- file.path(base_dir, 
                    "Shared drives", 
                    "Projects", 
                    "2025", 
                    "Orwell", 
                    "Breadcrumbs", 
                    "10 Quantitative Narrative Testing", 
                    "9 Main survey")
setwd(master)

arc = file.path(getwd(), "1 archive")
ipt = file.path(getwd(),"2a input")
temp = file.path(getwd(),"2b temp")
opt = file.path(getwd(),"2c output")
lg = file.path(getwd(),"3 log")
fig = file.path(getwd(),"4 figures")
tbl = file.path(getwd(),"5 tables")

##### DATA PREPARATION #####
# Set data date
date <- "20250304"

# Load data
dataname <- paste0("processed_",date,".csv") 
data <- file.path(temp,dataname) 
rdf <- fread(data)

# Generate value for total obs
total = nrow(rdf)
```


``` {r setup_plot_detail}
##### SET UP PLOT DETAILS #####
# Set graphic dimension for upcoming graphs
width = 3840
height = 2094
res = 300

# Setup custom font for plots
font_add_google("Barlow", "barlow")
showtext_auto()

# setting palette for plotplainblind
plotplainblind <- grDevices::colorRampPalette(
          colors = c("#808080", "#d0d0d0", "#abdaf4","#80cfb9","#f3cf80","#e6bcd3","#eaaf80", "#80b9d9","#f8f2a1"))(9)

subtitle <- paste0("(N=", total, ")")

# Setup template customization for plot
custom_theme <- function() {
  theme_minimal() +
    theme(
      legend.position = "bottom",
      legend.margin = margin(t = -20),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      text = element_text(family = "arial"),
      #plot.title = element_text(face = "bold"),
      axis.text.x = element_text(angle = 0,
                                 hjust = 0.5,
                                 vjust = 5,
                                 size = 10
      )
    )
}

```



``` {r demog_prep}
## prepare demographics
demographics <- rdf %>%
  mutate(prov = ID01) %>%
  mutate(urban = case_when(
    ID02 == 1 ~ 1,
    ID02 == 2 ~ 0
  )) %>%
  mutate(urban = factor(urban,
                        levels = c(1,0),
                        labels = c("Urban", "Rural"))) %>%
  mutate(gender = case_when(
    ID03 == 1 ~ 1,
    ID03 == 2 ~ 0
  )) %>%
  mutate(gender = factor(male,
                       levels = c(1,0),
                       labels = c("Male", "Female"))) %>%
  mutate(age = ID04) %>%
  mutate(age_group = case_when(
    age>=18 & age<=24 ~ 1,
    age>=25 & age<=34 ~ 2,
    age>=35 & age<=44 ~ 3, 
    age>=45 & age<=54 ~ 4,
    age>=55 & age<=64 ~ 5
  )) %>%
  mutate(age_group=factor(age_group,
                          levels = c(1,2,3,4,5),
                          labels = c("18-24", "25-34", "35-44", "45-54", "55-64"))) %>%
	mutate(educ = factor(ID06,
	                     levels = c(1,2,3,4,5),
	                     labels = c("Below primary school", "Primary school", 
	                                "Junior high school", "High school", "Higher education")))

demographics <- demographics %>%
  select(record, prov, urban, age, age_group, male, educ)


```


## SUBSECTION 1: TREATMENT COMPLIANCE

## 1.1 Stimulus reading time
Visualize statistical difference of stimulus reading time between each treatment arm and the control group

``` {r prep_pagetime}

pagetime_data <- rdf %>%
  select(record, lfCB, crt_intrpt_msg, agreestim, starts_with("pagetime"))

sum_readtime <- pagetime_data %>%
  group_by(lfCB) %>%
  summarise(mean = mean(pagetimeIntroSectionCB, na.rm=TRUE),
            sd = sd(pagetimeIntroSectionCB, na.rm=TRUE),
            min = min(pagetimeIntroSectionCB, na.rm=TRUE),
            max = max(pagetimeIntroSectionCB, na.rm=TRUE),
            n = n(),
            se = sd/sqrt(n), na.rm=TRUE) %>%
    mutate(treat = factor(lfCB,
                        levels = c(1,2,3,4,5, 6),
                        labels = c("1", "2", "3",
                                   "4", "5", "Control"))
         )

## Barplot reading time CB
ggplot(sum_readtime, aes(x = treat, y = mean, fill = factor(treat))) +
  geom_col(alpha = 0.7) +  # or geom_bar(stat="identity")
  #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), 
   #             width = 0.2, color = "black", size = 1) +
  scale_y_continuous(labels=NULL) +
   geom_text(aes(label = round(mean, 1)),
            hjust = 0.5, 
            vjust = -0.25,  
            size = 4) + 
  labs(title = "Stimulus reading time (minutes)", 
       x = "Stimulus", y = "") +
  custom_theme() +
  scale_fill_manual(values = c(
    "Control" = plotplainblind[2],
    "1" = plotplainblind[1],
    "2" = plotplainblind[1],
    "3" = plotplainblind[1],
    "4" = plotplainblind[1],
    "5" = plotplainblind[1]),
    name=NULL) +
  theme(legend.position = "none")
  
```

### With significant result from t-test

``` {r plot_diff_control}
## Statistics of control group
control_mean <- sum_readtime %>% 
  filter(lfCB == "6") %>% pull(mean)
control_sd <- sum_readtime %>% 
  filter(lfCB == "6") %>% pull(sd)
control_se <- sum_readtime %>% 
  filter(lfCB == "6") %>% pull(se)


## Summary difference stats
sum_diff_readtime <- sum_readtime %>%
  mutate(mean_diff = mean - control_mean,
         se_diff = sqrt(se^2 + control_se^2),
         ci_lower = mean_diff - 1.96 * se_diff,
         ci_upper = mean_diff + 1.96 * se_diff
         ) %>%
  filter(lfCB != 6) %>%
  mutate(treat = factor(lfCB,
                        levels = c(1,2,3,4,5),
                        labels = c("Stimulus 1", "Stimulus 2", "Stimulus 3",
                                   "Stimulus 4", "Stimulus 5"))
         )

## Plot
ggplot(sum_diff_readtime, aes(x = mean_diff, 
                              y = fct_relevel(treat, rev(levels(treat))))
       ) +
  geom_point(size = 4, color = "#abdaf4") +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.25, color = "#808080") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "#d0d0d0") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#d0d0d0") +
  labs(
    title = "Difference stimulus reading time from control group (minutes)",
    x = "Mean difference (Treatment - Control)",
    caption = paste0("Notes: control group mean of reading time is ", round(control_mean, 2), " minutes"),
    y = ""
  ) +
  custom_theme() +
  theme(plot.caption = element_text(hjust=0.5))

```

### With significant result from t-test

``` {r ttest_readtime_diff}
# Control group data
control_data <- pagetime_data %>% filter(lfCB == 6)
control_reading_times <- control_data$pagetimeIntroSectionCB

# Perform t-tests for each treatment group against the control group
t_test_results <- pagetime_data %>%
  filter(lfCB != 6) %>%
  group_by(lfCB) %>%
  summarise(
    p.value = t.test(pagetimeIntroSectionCB, control_reading_times, var.equal=FALSE)$p.value
  ) %>%
  mutate(treat = factor(lfCB,
                   levels = c(1, 2, 3, 4, 5),
                   labels = c("Stimulus 1", "Stimulus 2", "Stimulus 3",
                              "Stimulus 4", "Stimulus 5"))
  )

# Merge p-values into your summary data
sum_diff_readtime_ttest <- sum_diff_readtime %>%
  left_join(t_test_results %>% select(treat, p.value), by = "treat") %>%
  mutate(
    significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    # Adjust y_position for significance labels
    y_position = as.numeric(fct_relevel(treat, rev(levels(treat)))) # Get numeric position
  )

# Plot with significance labels
ggplot(sum_diff_readtime_ttest, aes(x = mean_diff,
                                   y = fct_relevel(treat, rev(levels(treat))))) +
  geom_point(size = 4, color = "#abdaf4") +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.25, color = "#808080") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "#d0d0d0") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#d0d0d0") +
  #geom_text(aes(x = ci_upper + 0.5, label = significance), vjust = 0.3, size = 4) + 
  geom_text(aes(y = treat, x = mean_diff, label = significance),
            vjust = 1.75, 
            hjust = 0.5, 
            size = 3) +
  labs(
    title = "Difference stimulus reading time from control group (minutes)",
    x = "Mean difference (Treatment - Control)",
    caption = paste0("Notes: control group mean of reading time is ", round(control_mean, 2), " minutes\nSignificance levels: *** < 0.001, ** < 0.01, * < 0.05, ns = not significant"),
    y = ""
  ) +
  custom_theme() +
  theme(plot.caption = element_text(hjust = 0.5)) 

```


## 1.2 Stimulus accuracy score
Visualize the degree of accurate interpretation in each treatment arm

``` {r prep_variables}

cb_data <- rdf %>%
  select(record, lfCB, starts_with("CB"), crt_intrpt_msg, agreestim)

# generate dummy for agreeing with statement
cb_data <- cb_data %>%
  mutate(
    d_agree = factor(agreestim,
                     levels=c(0,1),
                     labels=c("Disagree", "Agree")))

## notes: g agreestim=(lfCB==6)|(inrange(CB04,4,6) & (inrange(lfCB,1,3) | lfCB==5))|(inrange(CB04,1,3) & lfCB==4)

# generate dummy for correct interpretation with statement
cb_data <- cb_data %>%
  mutate(
    d_correct = factor(crt_intrpt_msg,
                     levels=c(0,1),
                     labels=c("Incorrect", "Correct")))

```

``` {r sum_accurate}
# Calculate percentage of correct interpretation by narrative
sum_accurate <- cb_data %>%
  group_by(lfCB, d_correct) %>%
  summarise(freq = n(), .groups = "drop") %>%
  group_by(lfCB) %>%
  mutate(total_nar = sum(freq), .groups = "drop") %>%
  group_by(lfCB, d_correct) %>%
  mutate(percent_correct = (freq/total_nar)*100)

sum_accurate_kable <- sum_accurate %>%
  filter(d_correct == "Correct") %>%
  rename(stimulus = lfCB) %>%
  filter(stimulus != 6) %>%
  select(stimulus, percent_correct) %>%
  ungroup() %>%
  mutate(word_count = c(75, 98, 89, 70, 130))

kable(sum_accurate_kable[c("stimulus", "word_count","percent_correct")],
      digits = 2,
      caption = "Percentage of stimulus accuracy",
      col.names = c("Stimulus", "Word count","Correct (%)"),
      align = c("l", "r", "r")
      ) 

```


## 1.3 Stimulus reading time by accuracy group
Visualize statistical difference of stimulus reading time between units who accurately interpreted their stimulus and those who don't


``` {r prep_pagetime_correct_treatment}

sum_time_correct <- pagetime_data %>%
  filter(lfCB != 6) %>%
  group_by(crt_intrpt_msg) %>%
  summarise(mean = mean(pagetimeIntroSectionCB, na.rm=TRUE),
            sd = sd(pagetimeIntroSectionCB, na.rm=TRUE),
            min = min(pagetimeIntroSectionCB, na.rm=TRUE),
            max = max(pagetimeIntroSectionCB, na.rm=TRUE),
            n = n(),
            se = sd/sqrt(n), na.rm=TRUE) %>%
  mutate(d_correct = factor(crt_intrpt_msg,
                     levels=c(0,1),
                     labels=c("Incorrect", "Correct")),
         group = "Treatment group" 
         )

count_treatment <- rdf %>% filter(lfCB != 6) %>% nrow()

```


### Without significant result from t-test
``` {r prep_pagetime_correct_all}

sum_time_correct_all <- pagetime_data %>%
  group_by(crt_intrpt_msg) %>%
  summarise(mean = mean(pagetimeIntroSectionCB, na.rm=TRUE),
            sd = sd(pagetimeIntroSectionCB, na.rm=TRUE),
            min = min(pagetimeIntroSectionCB, na.rm=TRUE),
            max = max(pagetimeIntroSectionCB, na.rm=TRUE),
            n = n(),
            se = sd/sqrt(n), na.rm=TRUE) %>%
  mutate(d_correct = factor(crt_intrpt_msg,
                     levels=c(0,1),
                     labels=c("Incorrect", "Correct")),
         group = "All sample" 
         )

count_all <- rdf %>% nrow()
```

``` {r facetplot_readingtime}
combined_summary <- bind_rows(sum_time_correct, sum_time_correct_all) %>%
  mutate(subtitle = case_when(
    group == "Treatment group" ~ paste0("Treatment group (N = ", count_treatment, ")"),
    group == "All sample" ~ paste0("All sample (N = ", count_all, ")")
  ))


ggplot(combined_summary, aes(x = d_correct, y = mean, fill = d_correct)) +
  geom_col(alpha = 0.7, fill = plotplainblind[1]) +
  geom_text(aes(label = round(mean, 1)),
    hjust = 0.5,
    vjust = -0.25,
    size = 4
  ) +
  facet_wrap(~ subtitle,
    scales = "free_y", # Allows y-axes to scale independently if needed
    ncol = 2
  ) +
  scale_y_continuous(limits = c(0,12), labels = NULL) +
  labs(
    title = "Means of stimulus reading time by accuracy (minutes)",
    caption = "Notes: All control observations are assumed to have correct interpretation",
    x = "", y = ""
  ) +
  custom_theme() +
  theme(
    legend.position = "none",
    #strip.background = element_rect(fill = "#d0d0d0"), # Optional: style facet labels
    strip.text = element_text(face = "bold"),          # Optional: style facet labels
    plot.caption = element_text(hjust = 0)
  ) 

```

### With significant result from t-test
``` {r ttest_readtime}
## Option 1: t-test
all_sample_test <- t.test(pagetimeIntroSectionCB ~ crt_intrpt_msg,
                          data = pagetime_data,
                          var.equal = FALSE) 

treatment_group_data <- pagetime_data %>% filter(lfCB != 6)
treatment_group_test <- t.test(pagetimeIntroSectionCB ~ crt_intrpt_msg,
                              data = treatment_group_data,
                              var.equal = FALSE)

p_value_all <- all_sample_test$p.value
p_value_treatment <- treatment_group_test$p.value
alpha <- 0.05 # Your chosen significance level

combined_summary <- combined_summary %>%
  mutate(significant = case_when(
    group == "All sample" & d_correct == "Correct" & p_value_all < alpha ~ TRUE,
    group == "Treatment group" & d_correct == "Correct" & p_value_treatment < alpha ~ TRUE,
    TRUE ~ FALSE
  )) %>%
  mutate(p_value = case_when(
    group == "All sample" & d_correct == "Correct" ~ p_value_all,
    group == "Treatment group" & d_correct == "Correct" ~ p_value_treatment
  ))

signif_stars <- function(p) {
  symnum(p,
         cutpoints = c(0, 0.001, 0.01, 0.05, 1),
         symbols = c("***", "**", "*", "ns"))
}

# Add significance labels to your combined summary data
combined_summary <- combined_summary %>%
  group_by(subtitle) %>%
  mutate(
    significance = signif_stars(p_value),
    # Adjust y_position based on your data's range to avoid overlap
    y_position = mean + 0.75 # Example: Position slightly above the bars
  ) %>%
  mutate(significance = case_when(
    is.na(p_value) ~ NA,
    !is.na(p_value) ~ significance
  )) %>%
  mutate(y_position = case_when(
    is.na(p_value) ~ NA,
    !is.na(p_value) ~ y_position
  ))

```

``` {r plot_ttest}

ggplot(combined_summary, aes(x = d_correct, y = mean, fill = d_correct)) +
  geom_col(fill = plotplainblind[1], width = 0.75) +
  geom_text(aes(label = round(mean, 1)),
            hjust = 0.5,
            vjust = -0.25,
            size = 4
  ) +
  facet_wrap(~ subtitle,
    scales = "free_y", # Allows y-axes to scale independently if needed
    ncol = 2
  ) +
  scale_y_continuous(limits = c(0, 12), labels = NULL) +
  labs(
    title = "Means of stimulus reading time by accuracy (minutes)",
    caption = "Notes: All control observations are assumed to have correct interpretation\nSignificance levels (t-test): *** < 0.001, ** < 0.01, * < 0.05, ns = not significant",
    x = "", y = ""
  ) +
  custom_theme() +
  theme(
    legend.position = "none",
    # strip.background = element_rect(fill = "#d0d0d0"), # Optional: style facet labels
    #strip.text = element_text(face = "bold"),          # Optional: style facet labels
    plot.caption = element_text(hjust = 0)
  ) +
  # Add significance symbols
  geom_text(aes(y = y_position, label = significance), size = 3, vjust = 0)

```

###################################################################################
\newpage
## SUBSECTION 2: STIMULUS RESPONSE

## 2.1 - NARRATIVE 1

### 2.1.1 Which resonated the most (CB03)
Show a comparison between the entire sample and those who correctly interpreted the stimulus (compliers) [separate graph]

``` {r prep_cb03a_correct}

sum_cb03_correct_nar1 <- cb_data %>%
  filter(lfCB == 1) %>%
  group_by(d_correct, CB03A) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(d_correct) %>%
  mutate(total_correct = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_correct)*100) 

sum_cb03_all_nar1 <- cb_data %>%
  filter(lfCB == 1) %>%
  group_by(CB03A) %>%
  summarise(freq = n(), .groups = 'drop') %>%
  ungroup() %>%
  mutate(total_correct = sum(freq)) %>%
  mutate(percent = (freq/total_correct)*100) %>%
  mutate(d_correct = "All Treatment 1")

sum_cb03_nar1 <- bind_rows(sum_cb03_correct_nar1, sum_cb03_all_nar1) %>%
  filter(d_correct != "Incorrect") %>%
  mutate(d_correct = replace(d_correct, d_correct == "Correct", "Correct Interpretation"))%>%
    mutate(sentence = factor(CB03A,
                           levels = c(1,2,3,4),
                           labels = c("What is the point of Indonesia continuing to develop\nif only a few people get to experience the results?",
                                      "All this time, the benefits of development have not\nreached all citizens.Those who enjoy it are the rich and\npowerful.Those at the bottom are still not prosperous.",
                                      "The government should improve the distribution of\ndevelopment benefits.The government must ensure that\nthe benefits can be enjoyed by all Indonesians.",
                                      "If the government can improve the distribution of\ndevelopment benefits,then all levels of society can thrive\nand improve their standard of living wherever they are.")))



```

``` {r plot_cb03a_correct, fig.width = 10, fig.height = 3.5}

label_counts <- sum_cb03_nar1 %>%
  filter(CB03A==1) %>%
  select(d_correct, total_correct) %>%
  mutate(label = paste0(d_correct, " (n = ", total_correct, ")")) %>%
  select(d_correct, label) %>%
  deframe()  # Convert to named vector


# Bar plot
p_cb03_nar1 <- ggplot(sum_cb03_nar1) +
    aes(x = fct_relevel(sentence, rev(levels(sentence))),
        y = percent) +
    facet_wrap(~d_correct, nrow=1, strip.position="top",
               labeller = labeller(d_correct = label_counts)) +
    geom_bar(stat = "identity", fill=plotplainblind[1]) +
    geom_text(aes(label = paste(round(percent, 0),"%")),
      vjust = 0.5,
      hjust = -0.1,
      size = 4
    ) +
    coord_flip() +
  scale_y_continuous(limit = c(0,50), labels=NULL) +
    labs(
      #title = paste("Sentence resonance of narrative 1"),
      #subtitle = subtitle,
      x = "",
      y = ""
    ) +
  custom_theme() +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust=0),
    strip.text = element_text(size = 11),
    axis.text.y = element_text(hjust = 0), 
  ) 
print(p_cb03_nar1)

```


### 2.1.2 Do they agree with the sentence? (CB04)
For each statement in each stimulus, visualize the rate of agreement

``` {r prep_cb04_nar1}

sum_cb04_nar1 <- cb_data %>%
  filter(lfCB == 1) %>%
  group_by(CB03A, CB04) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(CB03A) %>%
  mutate(total_sent = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_sent)*100) %>%
  mutate(percent_div = case_when(
    CB04 %in% c(4,5,6) ~ percent,
    CB04 %in% c(1,2,3) ~ -percent
  )) %>%
  mutate(agree_level = factor(CB04,
                              levels =c(1,2,3,6,5,4))) 


sum_cb04_nar1 <- sum_cb04_nar1 %>%
    mutate(sentence = factor(CB03A,
                           levels = c(1,2,3,4),
                           labels = c("What is the point of Indonesia continuing to develop\nif only a few people get to experience the results?",
                                      "All this time, the benefits of development have not\nreached all citizens.Those who enjoy it are the rich and\npowerful.Those at the bottom are still not prosperous.",
                                      "The government should improve the distribution of\ndevelopment benefits.The government must ensure that\nthe benefits can be enjoyed by all Indonesians.",
                                      "If the government can improve the distribution of\ndevelopment benefits,then all levels of society can thrive\nand improve their standard of living wherever they are.")))



```

``` {r plot_cb04_nar1, fig.height = 4.5, fig.width=10}
diverging_colors <- c("#fdae6b", "#fee6ce", "#f0f0f0", "#c6dbef", "#9ecae1","#6baed6")
names(diverging_colors) <- 1:6

ggplot(sum_cb04_nar1, aes(x = fct_relevel(sentence, rev(levels(sentence))), 
                          y = percent_div, 
                          fill = agree_level)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = rev(diverging_colors), name = "",
                     labels = c("Strongly Disagree", "Disagree", "Slightly Disagree",
                                    "Strongly Agree", "Agree", "Slightly Agree")) +
  coord_flip() +
  geom_text(aes(label = ifelse( percent > 5, paste0(round(percent),"%"),"")), 
            size = 3,
            hjust= 0.5,
            position = position_stack(vjust = 0.5)
            ) +
  labs(
    title = "Degree of Agreement (Stimulus 1)",
    y = "",
    x = ""
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = plotplainblind[1]) +
  scale_y_continuous(labels=NULL) +
  theme_minimal() +
  custom_theme() +
  theme(
    legend.position = "bottom",
    #legend.nrow = 1,
    axis.text.y = element_text(hjust = 0), # Align statement labels to the left
    panel.grid.major.y = element_blank() # Remove horizontal grid lines
  ) +
  guides(
    fill = guide_legend(
      ncol = 2,
      #order = 1,  # Controls the order of the legend
      breaks = c("Strongly Disagree",  "Slightly Agree", 
                 "Disagree", "Agree",
                 "Slightly Disagree", "Strongly Agree"),
      title = "",  # Title for the legend
      #title.position = "top",  # Position of the title
      title.hjust = 0.5  # Center the title
    ))

```

### 2.1.3 What emotions were evoked by the narrative (CB02)
Show a comparison between the entire sample and the compliers

``` {r emo_prep_all_sample}

# Select relevant columns
cb02_data <- cb_data %>%
  select(record, lfCB, starts_with("CB02"))

# Extract emotion variables
emotion_var <- cb02_data %>%
  select(starts_with("CB02")) %>%
  names()

# Replace answer 2 with 0
cb02_data <- cb02_data %>%
  mutate(across(all_of(emotion_var), ~ replace(., . == 2, 0)))

# Define emotion labels
emotion_list <- c(
  "1" = "Anger", "2" = "Anxiety", "3" = "Disgust", "4" = "Fear", 
  "5" = "Sad", "6" = "Happy", "7" = "Calm", "8" = "Longing", "9" = "Hopeless"
)

# Function to process each narrative
process_narrative <- function(narrative_num, prefix) {
  result_list <- vector("list", length(emotion_list))
  
  for (i in seq_along(emotion_list)) {
    emotion <- emotion_list[i]
    emotion_col <- paste0(prefix, i)

    summary_df <- cb02_data %>%
      filter(lfCB == narrative_num) %>%
      group_by(!!sym(emotion_col)) %>%
      summarise(freq = n(), .groups = 'drop') %>%
      mutate(percent = freq / sum(freq) * 100) %>%
      filter(!!sym(emotion_col) == 1) %>%
      mutate(emotion = emotion) %>%
      select(emotion, freq, percent) %>%
      mutate(narrative = narrative_num)

    result_list[[i]] <- summary_df
  }
  
  bind_rows(result_list) %>%
    mutate(narrative = narrative_num)
}

# Process all narratives in one go
prefixes <- c("CB02Ar", "CB02Br", "CB02Cr", "CB02Dr", "CB02Er")
sum_emotion_all <- purrr::map2_dfr(1:5, prefixes, process_narrative)

```

``` {r prep_emo_subsample_correct}
# Filter subsample
cb02_data_sub <- cb_data %>%
  filter(d_correct == "Correct") %>%
  select(record, lfCB, starts_with("CB02"))

# Replace answer 2 with 0
cb02_data_sub <- cb02_data_sub %>%
  mutate(across(all_of(emotion_var), ~ replace(., . == 2, 0)))


process_narrative_sub <- function(narrative_num, prefix) {
  result_list <- vector("list", length(emotion_list))
  
  for (i in seq_along(emotion_list)) {
    emotion <- emotion_list[i]
    emotion_col <- paste0(prefix, i)

    summary_df <- cb02_data_sub %>%
      filter(lfCB == narrative_num) %>%
      group_by(!!sym(emotion_col)) %>%
      summarise(freq = n(), .groups = 'drop') %>%
      mutate(percent = freq / sum(freq) * 100) %>%
      filter(!!sym(emotion_col) == 1) %>%
      mutate(emotion = emotion) %>%
      select(emotion, freq, percent)

    result_list[[i]] <- summary_df
  }
  
  bind_rows(result_list) %>%
    mutate(narrative = narrative_num)
}

# Process narratives for subsample
prefixes <- c("CB02Ar", "CB02Br", "CB02Cr", "CB02Dr", "CB02Er")
sum_emotion_subsample <- map2_dfr(1:5, prefixes, process_narrative_sub)
```

``` {r binding_for_lollipop}

sum_emotion_all <- sum_emotion_all %>%
  mutate(sample_type = paste0("All Treatment ",narrative))

sum_emotion_subsample <- sum_emotion_subsample %>%
  mutate(sample_type = "Correct Interpretation")

sum_emotion_combined <- bind_rows(sum_emotion_all, sum_emotion_subsample)

```

``` {r lollipop_nar1, fig.height=3, fig.width = 8}
lollipop_facet <- ggplot(subset(sum_emotion_combined, narrative==1), 
                         aes(x = percent, 
                             y = reorder(emotion, percent), 
                             color = factor(sample_type))) +
  geom_segment(aes(x = 0, 
                   xend = percent, 
                   yend = reorder(emotion, percent)), 
               size = 2, show.legend = FALSE) +
    scale_color_manual(values = plotplainblind) +
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(percent),"%")), 
            color = "black", size = 3,
            hjust = -0.5) +
  scale_x_continuous(limits = c(0,60), labels=NULL) +
  facet_wrap(~ sample_type,
             labeller = labeller(sample_type = label_counts)) +
  labs(title = "Emotions evoked by Narrative 1",
       #subtitle = "Comparison between full sample and those with correct interpretation",
       x = "",
       y = "") +
  custom_theme() +
  theme(strip.text = element_text(size = 11),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        legend.position = "none")

print(lollipop_facet)


```


## 2.2 - NARRATIVE 2

### 2.2.1 Which resonated the most (CB03)
``` {r prep_cb03b_correct}

sum_cb03_correct_nar2 <- cb_data %>%
  filter(lfCB == 2) %>%
  group_by(d_correct, CB03B) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(d_correct) %>%
  mutate(total_correct = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_correct)*100) 

sum_cb03_all_nar2 <- cb_data %>%
  filter(lfCB == 2) %>%
  group_by(CB03B) %>%
  summarise(freq = n(), .groups = 'drop') %>%
  ungroup() %>%
  mutate(total_correct = sum(freq)) %>%
  mutate(percent = (freq/total_correct)*100) %>%
  mutate(d_correct = "All Treatment 2")

sum_cb03_nar2 <- bind_rows(sum_cb03_correct_nar2, sum_cb03_all_nar2) %>%
  filter(d_correct != "Incorrect") %>%
  mutate(d_correct = replace(d_correct, d_correct == "Correct", "Correct Interpretation"))%>%
    mutate(sentence = factor(CB03B,
                           levels = c(1,2,3,4),
                           labels = c("What is the point of Indonesia developing \nbut there are so many people victimized?", 
                                      "For the sake of development, forests are deforested. \nFor the sake of development, many people \nlose their homes or livelihoods. This is \nnot progress, but regression.",
                                      "We might be able to get good jobs if many \nfactories and mines are built by destroying forests. \nBut what good is it if we get sick from pollution? \nHow will our children fare in the future \nif there are frequent floods or landslides? \nAnd if someone else is evicted today, what \nguarantee that we won't be evicted too?",
                                      "The government should ensure that no one's life \nor the environment is sacrificed \nfor the sake of development."
                                      )))



```

``` {r plot_cb03b_correct, fig.width = 10, fig.height = 4.5}

label_counts <- sum_cb03_nar2 %>%
  filter(CB03B==1) %>%
  select(d_correct, total_correct) %>%
  mutate(label = paste0(d_correct, " (n = ", total_correct, ")")) %>%
  select(d_correct, label) %>%
  deframe()  # Convert to named vector


# Bar plot
p_cb03_nar2 <- ggplot(sum_cb03_nar2) +
    aes(x = fct_relevel(sentence, rev(levels(sentence))), 
        y = percent) +
    facet_wrap(~d_correct, nrow=1, strip.position="top",
               labeller = labeller(d_correct = label_counts)) +
    geom_bar(stat = "identity", fill=plotplainblind[1]) +
    geom_text(aes(label = paste(round(percent, 0),"%")),
      vjust = 0.5,
      hjust = -0.1,
      size = 4
    ) +
    coord_flip() +
  scale_y_continuous(limit = c(0,50), labels=NULL) +
    labs(
      #title = paste("Sentence resonance of narrative 1"),
      #subtitle = subtitle,
      x = "",
      y = ""
    ) +
  custom_theme() +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust=0),
    strip.text = element_text(size = 11),
    axis.text.y = element_text(hjust = 0), 
  ) 
print(p_cb03_nar2)

```


### 2.2.2 Do they agree with the sentence? (CB04)
``` {r prep_cb04_nar2}

sum_cb04_nar2 <- cb_data %>%
  filter(lfCB == 2) %>%
  group_by(CB03B, CB04) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(CB03B) %>%
  mutate(total_sent = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_sent)*100) %>%
  mutate(percent_div = case_when(
    CB04 %in% c(4,5,6) ~ percent,
    CB04 %in% c(1,2,3) ~ -percent
  )) %>%
  mutate(agree_level = factor(CB04,
                              levels =c(1,2,3,6,5,4))) 


sum_cb04_nar2 <- sum_cb04_nar2 %>%
    mutate(sentence = factor(CB03B,
                           levels = c(1,2,3,4),
                           labels =  c("What is the point of Indonesia developing \nbut there are so many people victimized?", 
                                      "For the sake of development, forests are deforested. \nFor the sake of development, many people \nlose their homes or livelihoods. This is \nnot progress, but regression.",
                                      "We might be able to get good jobs if many \nfactories and mines are built by destroying forests. \nBut what good is it if we get sick from pollution? \nHow will our children fare in the future \nif there are frequent floods or landslides? \nAnd if someone else is evicted today, what \nguarantee that we won't be evicted too?",
                                      "The government should ensure that no one's life \nor the environment is sacrificed \nfor the sake of development."
                                      )))



```

``` {r plot_cb04_nar2, fig.height = 5.5, fig.width=10}
diverging_colors <- c("#fdae6b", "#fee6ce", "#f0f0f0", "#c6dbef", "#9ecae1","#6baed6")
names(diverging_colors) <- 1:6

ggplot(sum_cb04_nar2, aes(x = fct_relevel(sentence, rev(levels(sentence))), 
                          y = percent_div, 
                          fill = agree_level)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = rev(diverging_colors), name = "",
                     labels = c("Strongly Disagree", "Disagree", "Slightly Disagree",
                                    "Strongly Agree", "Agree", "Slightly Agree")) +
  coord_flip() +
  geom_text(aes(label = ifelse( percent > 5, paste0(round(percent),"%"),"")), 
            size = 3,
            hjust= 0.5,
            position = position_stack(vjust = 0.5)
            ) +
  labs(
    title = "Degree of Agreement (Stimulus 2)",
    y = "",
    x = ""
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = plotplainblind[1]) +
  scale_y_continuous(labels=NULL) +
  theme_minimal() +
  custom_theme() +
  theme(
    legend.position = "bottom",
    #legend.nrow = 1,
    axis.text.y = element_text(hjust = 0), # Align statement labels to the left
    panel.grid.major.y = element_blank() # Remove horizontal grid lines
  ) +
  guides(
    fill = guide_legend(
      ncol = 2,
      #order = 1,  # Controls the order of the legend
      breaks = c("Strongly Disagree",  "Slightly Agree", 
                 "Disagree", "Agree",
                 "Slightly Disagree", "Strongly Agree"),
      title = "",  # Title for the legend
      #title.position = "top",  # Position of the title
      title.hjust = 0.5  # Center the title
    ))

```

### 2.2.3 What emotions were evoked by the narrative (CB02)
``` {r lollipop_nar2, fig.height=3, fig.width = 8}
lollipop_facet <- ggplot(subset(sum_emotion_combined, narrative==2), 
                         aes(x = percent, 
                             y = reorder(emotion, percent), 
                             color = factor(sample_type))) +
  geom_segment(aes(x = 0, 
                   xend = percent, 
                   yend = reorder(emotion, percent)), 
               size = 2, show.legend = FALSE) +
    scale_color_manual(values = plotplainblind) +
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(percent),"%")), 
            color = "black", size = 3,
            hjust = -0.5) +
  scale_x_continuous(limits = c(0,70), labels=NULL) +
  facet_wrap(~ sample_type,
             labeller = labeller(sample_type = label_counts)) +
  labs(title = "Emotions evoked by Narrative 2",
       #subtitle = "Comparison between full sample and those with correct interpretation",
       x = "",
       y = "") +
  custom_theme() +
  theme(strip.text = element_text(size = 11),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        legend.position = "none")

print(lollipop_facet)


```


## 2.3 - NARRATIVE 3

### 2.3.1 Which resonated the most (CB03)
``` {r prep_cb03c_correct}

sum_cb03_correct_nar3 <- cb_data %>%
  filter(lfCB == 3) %>%
  group_by(d_correct, CB03C) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(d_correct) %>%
  mutate(total_correct = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_correct)*100) 

sum_cb03_all_nar3 <- cb_data %>%
  filter(lfCB == 3) %>%
  group_by(CB03C) %>%
  summarise(freq = n(), .groups = 'drop') %>%
  ungroup() %>%
  mutate(total_correct = sum(freq)) %>%
  mutate(percent = (freq/total_correct)*100) %>%
  mutate(d_correct = "All Treatment 3")

sum_cb03_nar3 <- bind_rows(sum_cb03_correct_nar3, sum_cb03_all_nar3) %>%
  filter(d_correct != "Incorrect") %>%
  mutate(d_correct = replace(d_correct, d_correct == "Correct", "Correct Interpretation"))%>%
    mutate(sentence = factor(CB03C,
                           levels = c(1,2,3,4),
                           labels = c("What is the point of having flyovers and magnificent \nbuildings like the developed countries, if the quality \nof our human resources is still lagging behind?",
                                      "The quality of human resources improves if the quality \nof our education improves. Consequently, school graduates \nare able to solve problems and make innovations, have \ndiscipline, and can work with others.", 
                                      "Qualified human resources have wider job opportunities. \nThey can also open jobs in many places. Meanwhile, \nthe benefits of flyovers and magnificent buildings \nare only enjoyed by people in big cities.",
                                      "The government should reduce waste in building \nphysical facilities to increase the budget \nfor education, research, and culture."
                                      )))

```

``` {r plot_cb03c_correct, fig.width = 10, fig.height = 3.5}

label_counts <- sum_cb03_nar3 %>%
  filter(CB03C==1) %>%
  select(d_correct, total_correct) %>%
  mutate(label = paste0(d_correct, " (n = ", total_correct, ")")) %>%
  select(d_correct, label) %>%
  deframe()  # Convert to named vector


# Bar plot
p_cb03_nar3 <- ggplot(sum_cb03_nar3) +
    aes(x = fct_relevel(sentence, rev(levels(sentence))), 
        y = percent) +
    facet_wrap(~d_correct, nrow=1, strip.position="top",
               labeller = labeller(d_correct = label_counts)) +
    geom_bar(stat = "identity", fill=plotplainblind[1]) +
    geom_text(aes(label = paste(round(percent, 0),"%")),
      vjust = 0.5,
      hjust = -0.1,
      size = 4
    ) +
    coord_flip() +
  scale_y_continuous(limit = c(0,45), labels=NULL) +
    labs(
      #title = paste("Sentence resonance of narrative 1"),
      #subtitle = subtitle,
      x = "",
      y = ""
    ) +
  custom_theme() +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust=0),
    strip.text = element_text(size = 11),
    axis.text.y = element_text(hjust = 0), 
  ) 
print(p_cb03_nar3)

```


### 2.3.2 Do they agree with the sentence? (CB04)
``` {r prep_cb04_nar3}

sum_cb04_nar3 <- cb_data %>%
  filter(lfCB == 3) %>%
  group_by(CB03C, CB04) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(CB03C) %>%
  mutate(total_sent = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_sent)*100) %>%
  mutate(percent_div = case_when(
    CB04 %in% c(4,5,6) ~ percent,
    CB04 %in% c(1,2,3) ~ -percent
  )) %>%
  mutate(agree_level = factor(CB04,
                              levels =c(1,2,3,6,5,4))) 


sum_cb04_nar3 <- sum_cb04_nar3 %>%
    mutate(sentence = factor(CB03C,
                           levels = c(1,2,3,4),
                           labels = c("What is the point of having flyovers and magnificent \nbuildings like the developed countries, if the quality \nof our human resources is still lagging behind?",
                                      "The quality of human resources improves if the quality \nof our education improves. Consequently, school graduates \nare able to solve problems and make innovations, have \ndiscipline, and can work with others.", 
                                      "Qualified human resources have wider job opportunities. \nThey can also open jobs in many places. Meanwhile, \nthe benefits of flyovers and magnificent buildings \nare only enjoyed by people in big cities.",
                                      "The government should reduce waste in building \nphysical facilities to increase the budget \nfor education, research, and culture."
                                      )))



```

``` {r plot_cb04_nar3, fig.height = 4.5, fig.width=10}
diverging_colors <- c("#fdae6b", "#fee6ce", "#f0f0f0", "#c6dbef", "#9ecae1","#6baed6")
names(diverging_colors) <- 1:6

ggplot(sum_cb04_nar3, aes(x = fct_relevel(sentence, rev(levels(sentence))),
                          y = percent_div, 
                          fill = agree_level)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = rev(diverging_colors), name = "",
                     labels = c("Strongly Disagree", "Disagree", "Slightly Disagree",
                                    "Strongly Agree", "Agree", "Slightly Agree")) +
  coord_flip() +
  geom_text(aes(label = ifelse( percent > 5, paste0(round(percent),"%"),"")), 
            size = 3,
            hjust= 0.5,
            position = position_stack(vjust = 0.5)
            ) +
  labs(
    title = "Degree of Agreement (Stimulus 3)",
    y = "",
    x = ""
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = plotplainblind[1]) +
  scale_y_continuous(labels=NULL) +
  theme_minimal() +
  custom_theme() +
  theme(
    legend.position = "bottom",
    #legend.nrow = 1,
    axis.text.y = element_text(hjust = 0), # Align statement labels to the left
    panel.grid.major.y = element_blank() # Remove horizontal grid lines
  ) +
  guides(
    fill = guide_legend(
      ncol = 2,
      #order = 1,  # Controls the order of the legend
      breaks = c("Strongly Disagree",  "Slightly Agree", 
                 "Disagree", "Agree",
                 "Slightly Disagree", "Strongly Agree"),
      title = "",  # Title for the legend
      #title.position = "top",  # Position of the title
      title.hjust = 0.5  # Center the title
    ))

```

### 2.3.3 What emotions were evoked by the narrative (CB02)
``` {r lollipop_nar3, fig.height=3, fig.width = 8}
lollipop_facet <- ggplot(subset(sum_emotion_combined, narrative==3), 
                         aes(x = percent, 
                             y = reorder(emotion, percent), 
                             color = factor(sample_type))) +
  geom_segment(aes(x = 0, 
                   xend = percent, 
                   yend = reorder(emotion, percent)), 
               size = 2, show.legend = FALSE) +
    scale_color_manual(values = plotplainblind) +
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(percent),"%")), 
            color = "black", size = 3,
            hjust = -0.5) +
  scale_x_continuous(limits = c(0,60), labels=NULL) +
  facet_wrap(~ sample_type,
             labeller = labeller(sample_type = label_counts)) +
  labs(title = "Emotions evoked by Narrative 3",
       #subtitle = "Comparison between full sample and those with correct interpretation",
       x = "",
       y = "") +
  custom_theme() +
  theme(strip.text = element_text(size = 11),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        legend.position = "none")

print(lollipop_facet)


```


## 2.4 - NARRATIVE 4

### 2.4.1 Which resonated the most (CB03)
``` {r prep_cb03d_correct}

sum_cb03_correct_nar4 <- cb_data %>%
  filter(lfCB == 4) %>%
  group_by(d_correct, CB03D) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(d_correct) %>%
  mutate(total_correct = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_correct)*100) 

sum_cb03_all_nar4 <- cb_data %>%
  filter(lfCB == 4) %>%
  group_by(CB03D) %>%
  summarise(freq = n(), .groups = 'drop') %>%
  ungroup() %>%
  mutate(total_correct = sum(freq)) %>%
  mutate(percent = (freq/total_correct)*100) %>%
  mutate(d_correct = "All Treatment 4")

sum_cb03_nar4 <- bind_rows(sum_cb03_correct_nar4, sum_cb03_all_nar4) %>%
  filter(d_correct != "Incorrect") %>%
  mutate(d_correct = replace(d_correct, d_correct == "Correct", "Correct Interpretation"))%>%
    mutate(sentence = factor(CB03D,
                           levels = c(1,2,3,4),
                           labels = c("Why do we still doubt the government that \nhas held the people's mandate?",
                                      "The government is the only entity in power \nbecause it has been elected by the people. This \nmeans that the government has the full authority \nto lead and make decisions for all the people.",
                                      "The government has the right to set rules, \nenforce laws, and take actions that it deems \nnecessary in the interest of the country, even if \nit is sometimes against the wishes of some people.",
                                      "People can submit ideas or complaints. \nHowever, the final decision remains \nin the hands of the government"
                           )))

```

``` {r plot_cb03d_correct, fig.width = 10, fig.height = 3.5}

label_counts <- sum_cb03_nar4 %>%
  filter(CB03D==1) %>%
  select(d_correct, total_correct) %>%
  mutate(label = paste0(d_correct, " (n = ", total_correct, ")")) %>%
  select(d_correct, label) %>%
  deframe()  # Convert to named vector


# Bar plot
p_cb03_nar4 <- ggplot(sum_cb03_nar4) +
    aes(x = fct_relevel(sentence, rev(levels(sentence))),
        y = percent) +
    facet_wrap(~d_correct, nrow=1, strip.position="top",
               labeller = labeller(d_correct = label_counts)) +
    geom_bar(stat = "identity", fill=plotplainblind[1]) +
    geom_text(aes(label = paste(round(percent, 0),"%")),
      vjust = 0.5,
      hjust = -0.1,
      size = 4
    ) +
    coord_flip() +
  scale_y_continuous(limit = c(0,40), labels=NULL) +
    labs(
      #title = paste("Sentence resonance of narrative 1"),
      #subtitle = subtitle,
      x = "",
      y = ""
    ) +
  custom_theme() +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust=0),
    strip.text = element_text(size = 11),
    axis.text.y = element_text(hjust = 0), 
  ) 
print(p_cb03_nar4)

```


### 2.4.2 Do they agree with the sentence? (CB04)
``` {r prep_cb04_nar4}

sum_cb04_nar4 <- cb_data %>%
  filter(lfCB == 4) %>%
  group_by(CB03D, CB04) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(CB03D) %>%
  mutate(total_sent = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_sent)*100) %>%
  mutate(percent_div = case_when(
    CB04 %in% c(4,5,6) ~ -percent,
    CB04 %in% c(1,2,3) ~ percent
  )) %>%
  mutate(agree_level = factor(CB04,
                              levels =c(6,5,4,1,2,3))) 


sum_cb04_nar4 <- sum_cb04_nar4 %>%
    mutate(sentence = factor(CB03D,
                           levels = c(1,2,3,4),
                           labels = c("Why do we still doubt the government that \nhas held the people's mandate?",
                                      "The government is the only entity in power \nbecause it has been elected by the people. This \nmeans that the government has the full authority \nto lead and make decisions for all the people.",
                                      "The government has the right to set rules, \nenforce laws, and take actions that it deems \nnecessary in the interest of the country, even if \nit is sometimes against the wishes of some people.",
                                      "People can submit ideas or complaints. \nHowever, the final decision remains \nin the hands of the government"
                           )))



```

``` {r plot_cb04_nar4, fig.height = 4.5, fig.width=10}
diverging_colors <- c("#6baed6", "#9ecae1", "#c6dbef", "#f0f0f0", "#fee6ce", "#fdae6b")
names(diverging_colors) <- 1:6

ggplot(sum_cb04_nar4, aes(x = fct_relevel(sentence, rev(levels(sentence))),
                          y = percent_div, 
                          fill = agree_level)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = rev(diverging_colors), name = "",
                     labels = c("Strongly Disagree", "Disagree", "Slightly Disagree",
                                "Strongly Agree", "Agree", "Slightly Agree"
                                    )) +
  coord_flip() +
  geom_text(aes(label = ifelse( percent > 5, paste0(round(percent),"%"),"")), 
            size = 3,
            hjust= 0.5,
            position = position_stack(vjust = 0.5)
            ) +
  labs(
    title = "Degree of Agreement (Stimulus 4)",
    y = "",
    x = ""
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = plotplainblind[1]) +
  scale_y_continuous(labels=NULL) +
  theme_minimal() +
  custom_theme() +
  theme(
    legend.position = "bottom",
    #legend.nrow = 1,
    axis.text.y = element_text(hjust = 0), # Align statement labels to the left
    panel.grid.major.y = element_blank() # Remove horizontal grid lines
  ) +
  guides(
    fill = guide_legend(
      ncol = 2,
      #order = 1,  # Controls the order of the legend
      breaks = c("Strongly Disagree",  "Slightly Agree", 
                 "Disagree", "Agree",
                 "Slightly Disagree", "Strongly Agree"),
      title = "",  # Title for the legend
      #title.position = "top",  # Position of the title
      title.hjust = 0.5  # Center the title
    ))

```

### 2.4.3 What emotions were evoked by the narrative (CB02)
``` {r lollipop_nar4, fig.height=3, fig.width = 8}
lollipop_facet <- ggplot(subset(sum_emotion_combined, narrative==4), 
                         aes(x = percent, 
                             y = reorder(emotion, percent), 
                             color = factor(sample_type))) +
  geom_segment(aes(x = 0, 
                   xend = percent, 
                   yend = reorder(emotion, percent)), 
               size = 2, show.legend = FALSE) +
    scale_color_manual(values = plotplainblind) +
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(percent),"%")), 
            color = "black", size = 3,
            hjust = -0.5) +
  scale_x_continuous(limits = c(0,60), labels=NULL) +
  facet_wrap(~ sample_type,
             labeller = labeller(sample_type = label_counts)) +
  labs(title = "Emotions evoked by Narrative 3",
       #subtitle = "Comparison between full sample and those with correct interpretation",
       x = "",
       y = "") +
  custom_theme() +
  theme(strip.text = element_text(size = 11),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        legend.position = "none")

print(lollipop_facet)


```


## 2.5 - NARRATIVE 5

### 2.5.1 Which resonated the most (CB03)
``` {r prep_cb03e_correct}

sum_cb03_correct_nar5 <- cb_data %>%
  filter(lfCB == 5) %>%
  group_by(d_correct, CB03E) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(d_correct) %>%
  mutate(total_correct = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_correct)*100) 

sum_cb03_all_nar5 <- cb_data %>%
  filter(lfCB == 5) %>%
  group_by(CB03E) %>%
  summarise(freq = n(), .groups = 'drop') %>%
  ungroup() %>%
  mutate(total_correct = sum(freq)) %>%
  mutate(percent = (freq/total_correct)*100) %>%
  mutate(d_correct = "All Treatment 5")

sum_cb03_nar5 <- bind_rows(sum_cb03_correct_nar5, sum_cb03_all_nar5) %>%
  filter(d_correct != "Incorrect") %>%
  mutate(d_correct = replace(d_correct, d_correct == "Correct", "Correct Interpretation"))%>%
    mutate(sentence = factor(CB03E,
                           levels = c(1,2,3,4),
                           labels = c("They say Indonesia guarantees the welfare of all its \ncitizens, but why is the fate of the rich and poor so different?",
                                      "From the womb, children from poor families are left behind. \nDuring pregnancy, mothers do not receive good health \nand nutrition services. When the children grow up, the family \ncannot afford to send them to a good school. They also \ntend to drop out of school. As adults, they cannot get \na decent job, so they and their descendants remain poor.",
                                      "In contrast, children from a wealthy family are guaranteed \na good life from the womb. Their mothers are healthy, \ntheir neighborhoods are clean and safe, and they can go \nto school until they graduate. As adults, they can get good jobs \nso that their economic conditions can continue to improve.",
                                      "The government should improve the coverage and \nquality of health, education, and social services. So that \nchildren from rich and poor families can have \nequal opportunities to live prosperous lives."
                           )))

```

``` {r plot_cb03e_correct, fig.width = 10, fig.height = 4.5}

label_counts <- sum_cb03_nar5 %>%
  filter(CB03E==1) %>%
  select(d_correct, total_correct) %>%
  mutate(label = paste0(d_correct, " (n = ", total_correct, ")")) %>%
  select(d_correct, label) %>%
  deframe()  # Convert to named vector


# Bar plot
p_cb03_nar5 <- ggplot(sum_cb03_nar5) +
    aes(x = fct_relevel(sentence, rev(levels(sentence))),
        y = percent) +
    facet_wrap(~d_correct, nrow=1, strip.position="top",
               labeller = labeller(d_correct = label_counts)) +
    geom_bar(stat = "identity", fill=plotplainblind[1]) +
    geom_text(aes(label = paste(round(percent, 0),"%")),
      vjust = 0.5,
      hjust = -0.1,
      size = 4
    ) +
    coord_flip() +
  scale_y_continuous(limit = c(0,60), labels=NULL) +
    labs(
      #title = paste("Sentence resonance of narrative 1"),
      #subtitle = subtitle,
      x = "",
      y = ""
    ) +
  custom_theme() +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust=0),
    strip.text = element_text(size = 11),
    axis.text.y = element_text(hjust = 0), 
  ) 
print(p_cb03_nar5)

```


### 2.5.2 Do they agree with the sentence? (CB04)
``` {r prep_cb04_nar5}

sum_cb04_nar5 <- cb_data %>%
  filter(lfCB == 5) %>%
  group_by(CB03E, CB04) %>%
  summarise(freq = n(), .groups='drop') %>%
  group_by(CB03E) %>%
  mutate(total_sent = sum(freq), .groups = 'drop') %>%
  mutate(percent = (freq/total_sent)*100) %>%
  mutate(percent_div = case_when(
    CB04 %in% c(4,5,6) ~ percent,
    CB04 %in% c(1,2,3) ~ -percent
  )) %>%
  mutate(agree_level = factor(CB04,
                              levels =c(1,2,3,6,5,4))) 


sum_cb04_nar5 <- sum_cb04_nar5 %>%
    mutate(sentence = factor(CB03E,
                           levels = c(1,2,3,4),
                           labels = c("They say Indonesia guarantees the welfare of all its \ncitizens, but why is the fate of the rich and poor so different?",
                                      "From the womb, children from poor families are left behind. \nDuring pregnancy, mothers do not receive good health \nand nutrition services. When the children grow up, the family \ncannot afford to send them to a good school. They also \ntend to drop out of school. As adults, they cannot get \na decent job, so they and their descendants remain poor.",
                                      "In contrast, children from a wealthy family are guaranteed \na good life from the womb. Their mothers are healthy, \ntheir neighborhoods are clean and safe, and they can go \nto school until they graduate. As adults, they can get good jobs \nso that their economic conditions can continue to improve.",
                                      "The government should improve the coverage and \nquality of health, education, and social services. So that \nchildren from rich and poor families can have \nequal opportunities to live prosperous lives."
                           )))




```

``` {r plot_cb04_nar5, fig.height = 5.5, fig.width=10}
diverging_colors <- c("#fdae6b", "#fee6ce", "#f0f0f0", "#c6dbef", "#9ecae1","#6baed6")
names(diverging_colors) <- 1:6

ggplot(sum_cb04_nar5, aes(x = fct_relevel(sentence, rev(levels(sentence))), 
                          y = percent_div, 
                          fill = agree_level)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = rev(diverging_colors), name = "",
                     labels = c("Strongly Disagree", "Disagree", "Slightly Disagree",
                                    "Strongly Agree", "Agree", "Slightly Agree")) +
  coord_flip() +
  geom_text(aes(label = ifelse( percent > 5, paste0(round(percent),"%"),"")), 
            size = 3,
            hjust= 0.5,
            position = position_stack(vjust = 0.5)
            ) +
  labs(
    title = "Degree of Agreement (Stimulus 5)",
    y = "",
    x = ""
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = plotplainblind[1]) +
  scale_y_continuous(labels=NULL) +
  theme_minimal() +
  custom_theme() +
  theme(
    legend.position = "bottom",
    #legend.nrow = 1,
    axis.text.y = element_text(hjust = 0), # Align statement labels to the left
    panel.grid.major.y = element_blank() # Remove horizontal grid lines
  ) +
  guides(
    fill = guide_legend(
      ncol = 2,
      #order = 1,  # Controls the order of the legend
      breaks = c("Strongly Disagree",  "Slightly Agree", 
                 "Disagree", "Agree",
                 "Slightly Disagree", "Strongly Agree"),
      title = "",  # Title for the legend
      #title.position = "top",  # Position of the title
      title.hjust = 0.5  # Center the title
    ))

```

### 2.5.3 What emotions were evoked by the narrative (CB02)
``` {r lollipop_nar5, fig.height=3, fig.width = 8}
lollipop_facet <- ggplot(subset(sum_emotion_combined, narrative==5), 
                         aes(x = percent, 
                             y = reorder(emotion, percent), 
                             color = factor(sample_type))) +
  geom_segment(aes(x = 0, 
                   xend = percent, 
                   yend = reorder(emotion, percent)), 
               size = 2, show.legend = FALSE) +
    scale_color_manual(values = plotplainblind) +
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(percent),"%")), 
            color = "black", size = 3,
            hjust = -0.5) +
  scale_x_continuous(limits = c(0,85), labels=NULL) +
  facet_wrap(~ sample_type,
             labeller = labeller(sample_type = label_counts)) +
  labs(title = "Emotions evoked by Narrative 5",
       #subtitle = "Comparison between full sample and those with correct interpretation",
       x = "",
       y = "") +
  custom_theme() +
  theme(strip.text = element_text(size = 11),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        legend.position = "none")

print(lollipop_facet)

```




## 2.6 Heatmap of emotions evoked (alternative visualization)

``` {r heatmap_emotion_all_sample}

breaks_val <- c(0, 20, 40, 60, 80)
colors_val <- c("white", "#D3D3D3", "#808080", "#595959", "#363636")

obs_counts <- cb02_data %>%
  group_by(narrative = factor(ifelse(lfCB == 1, 1,
                                     ifelse(lfCB == 2, 2,
                                            ifelse(lfCB == 3, 3,
                                                   ifelse(lfCB == 4, 4, 
                                                          ifelse(lfCB == 5,5,NA))))))) %>%
  summarise(n_obs = n(), .groups = 'drop')

label_nar <- paste0(levels(factor(sum_emotion_all$narrative)),
                    "\n(n=", obs_counts$n_obs, ")")

heatmap_emo <- ggplot(sum_emotion_all, aes(x = factor(narrative), y = reorder(emotion, (percent)), fill = percent)) +
  geom_tile() +
  scale_fill_gradientn(colors = colors_val, breaks = breaks_val, limits = c(0, 80)) +
  geom_text(aes(label = round(percent, 2)), color = "black", size = 3) +
  #facet_wrap(~ Foundation, scales = "free") +
  labs(title = "Emotions evoked for all treatment group (%)",
       #subtitle = subtitle,
       x = "Narrative",
       y = "Emotion",
       fill = "Percentage") +
  theme_minimal() +
  custom_theme() +
  scale_x_discrete(position="top",
                   labels = label_nar) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
        legend.position = "right")
print(heatmap_emo)
```

``` {r heatmap_emotion_all_subsample}

breaks_val <- c(0, 20, 40, 60, 80)
colors_val <- c("white", "#D3D3D3", "#808080", "#595959", "#363636")

obs_counts_sub <- cb02_data_sub %>%
  group_by(narrative = factor(ifelse(lfCB == 1, 1,
                                     ifelse(lfCB == 2, 2,
                                            ifelse(lfCB == 3, 3,
                                                   ifelse(lfCB == 4, 4, 
                                                          ifelse(lfCB == 5,5,NA))))))) %>%
  summarise(n_obs = n(), .groups = 'drop')

label_nar_sub <- paste0(levels(factor(sum_emotion_subsample$narrative)),
                    "\n(n=", obs_counts_sub$n_obs, ")")

heatmap_emo_sub <- ggplot(sum_emotion_subsample, aes(x = factor(narrative), y = reorder(emotion, (percent)), fill = percent)) +
  geom_tile() +
  scale_fill_gradientn(colors = colors_val, breaks = breaks_val, limits = c(0, 80)) +
  geom_text(aes(label = round(percent, 2)), color = "black", size = 3) +
  #facet_wrap(~ Foundation, scales = "free") +
  labs(title = "Emotions evoked for treatment with correct interpretation (%)",
       #subtitle = subtitle,
       x = "Narrative",
       y = "Emotion",
       fill = "Percentage") +
  theme_minimal() +
  custom_theme() +
  scale_x_discrete(position="top",
                   labels = label_nar_sub) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5),
        legend.position = "right")
print(heatmap_emo_sub)
```


## SUPPLEMENTAL MATERIALS (non-priority, upcoming)
## 3.1 Demographics on likelihood of agreeing 


\newpage
## Appendix) Demographics figure (Statistical difference of key characteristics between the sample and the population) -- see paper draft [upcoming] 
https://cran.r-project.org/web/packages/forestplot/vignettes/forestplot.html
https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/forest.html

``` {r trial_forest_plot}


```



``` {r archive_prep}
## ARCHIVE
###################################################################################

## 1) Tabulation: % of accuracy and % agreement of those who is correctly interpret


# generate dummy for correct interpretation
narrative <- c("A", "B", "C", "D", "E")

for (x in narrative) {
  col_name <- paste0("CB01_cor_", x)
  cb01_col <- paste0("CB01", x)

  if (x == "D") {
    cb_data <- cb_data %>%
      mutate(!!sym(col_name) := ifelse(CB01D >= 2 & CB01D <= 3, 1, 0))
  } else {
    cb_data <- cb_data %>%
      mutate(!!sym(col_name) := ifelse(!!sym(cb01_col) == 1, 1, 0))
  }
  
cb_data <- cb_data %>%
    mutate(!!sym(col_name) := ifelse(lfCB == 6, 1, !!sym(col_name)))
}



correct_cols <- paste0("CB01_cor_", narrative)

cb_data <- cb_data %>%
  rowwise() %>%
  mutate(d_correct := max(c_across(all_of(correct_cols)), na.rm = TRUE)) %>%
  ungroup()


# Calculate percentage of agree by narrative and accuracy
sum_agree <- cb_data %>%
  group_by(lfCB, d_correct, d_agree) %>%
  summarise(freq = n(), .groups = "drop") %>%
  group_by(lfCB, d_correct) %>%
  mutate(total_cor_nar = sum(freq), .groups = "drop") %>%
  group_by(lfCB, d_correct, d_agree) %>%
  mutate(percent_agree = (freq/total_cor_nar)*100)

sum_agree_kable <- sum_agree %>%
  filter(d_correct == "Correct" & d_agree == "Agree") %>%
  rename(stimulus = lfCB) %>%
  select(stimulus, percent_agree)

# Combining the table for specified column
sum_kable <- sum_accurate_kable %>%
  full_join(sum_agree_kable, by = "stimulus") %>%
  select(stimulus, percent_correct, percent_agree) %>%
  filter(stimulus!=6)

```


``` {r archive_sum_accurate}
# Calculate percentage of correct interpretation by narrative
sum_accurate <- cb_data %>%
  group_by(lfCB, d_correct) %>%
  summarise(freq = n(), .groups = "drop") %>%
  group_by(lfCB) %>%
  mutate(total_nar = sum(freq), .groups = "drop") %>%
  group_by(lfCB, d_correct) %>%
  mutate(percent_correct = (freq/total_nar)*100)

sum_accurate_kable <- sum_accurate %>%
  filter(d_correct == "Correct") %>%
  rename(stimulus = lfCB) %>%
  select(stimulus, percent_correct)


# Calculate percentage of agree by narrative and accuracy
sum_agree <- cb_data %>%
  group_by(lfCB, d_correct, d_agree) %>%
  summarise(freq = n(), .groups = "drop") %>%
  group_by(lfCB, d_correct) %>%
  mutate(total_cor_nar = sum(freq), .groups = "drop") %>%
  group_by(lfCB, d_correct, d_agree) %>%
  mutate(percent_agree = (freq/total_cor_nar)*100)

sum_agree_kable <- sum_agree %>%
  filter(d_correct == "Correct" & d_agree == "Agree") %>%
  rename(stimulus = lfCB) %>%
  select(stimulus, percent_agree)

# Combining the table for specified column
sum_kable <- sum_accurate_kable %>%
  full_join(sum_agree_kable, by = "stimulus") %>%
  select(stimulus, percent_correct, percent_agree) %>%
  filter(stimulus!=6)

kable_correct_agree <- kable(sum_kable,
      digits = 2,
      caption = "Percentage of stimulus accuracy and agreement",
      col.names = c("Stimulus", "Correct (%)", "Agree(%)"),
      align = c("l", "r", "r")
      ) 
#cat("Notes: percentage of agreement is calculated of those who interpret stimulus correctly.\n")

```



``` {r arc_prep_reg_data}
## 2) Logit regression of demographics on accuracy 
#Depedent variable is binary variable of accuracy (1: correct interpretaion of stimulus, 0: incorrect interpretation). Base group for age_group is "18-24", base group for education is "Primary school"

reg_data <- cb_data %>%
  inner_join(demographics, by = "record")
```

``` {r arc_loop_logit_correct}

all_results <- list()

for (i in 1:5) {
  # Filter for one narrative
  data_nar <- reg_data %>%
    filter(lfCB == i) %>%
    droplevels()  # Drop unused factor levels
  
  # Run logistic regression
  model <- glm(d_correct ~ male + age_group + educ + urban,
               data = data_nar, family = "binomial")
  
  # Get marginal effects
  marginal <- margins(model)
  summary_marginal <- summary(marginal)
  
  # Format result
  formatted <- summary_marginal %>%
    as_tibble() %>%
    mutate(
      marginal_effect = scales::percent(AME, accuracy = 0.1),
      p_value = ifelse(p < 0.001, "<0.001", format(round(p, 3), nsmall = 3)),
      significance = case_when(
        p < 0.001 ~ "***",
        p < 0.01 ~ "**",
        p < 0.05 ~ "*",
        p < 0.1 ~ ".",
        TRUE ~ ""
      ),
      narrative = i
    ) %>%
    select(narrative, factor, AME, p_value, significance)
  
  all_results[[i]] <- formatted
}

# Combine all into one table
final_table <- bind_rows(all_results)


```

``` {r arc_kable_output_ame_correct}
# Format cell content as simple plain-text strings
formatted_table <- final_table %>%
  mutate(
    p_value_num = as.numeric(p_value),
    p_value_fmt = ifelse(
      is.na(p_value_num),
      as.character(p_value),
      sprintf("%.3f", p_value_num)
    ),
    cell = paste0(sprintf("%.3f", AME), " ", "(p = ", p_value_fmt, ")", significance)
  ) %>%
  select(narrative, factor, cell) %>%
  pivot_wider(names_from = narrative, values_from = cell, names_prefix = "Narrative ")

# Output simple PDF-friendly kable
kable_logit_correct <- formatted_table %>%
  rename(`Predictor` = factor) %>%
  kable(
    booktabs = TRUE,
    longtable = TRUE,
    escape = TRUE,
    caption = "Average Marginal Effects on Correct Interpretation"
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "repeat_header"),
    font_size = 6.5
  ) %>%
  column_spec(1, bold = TRUE)
```




``` {r arc_loop_logit_agree}
## 3) Logit regression of demographics on agreement 
#Depedent variable is binary variable of agreement (1: agree with stimulus, 0: disagree). Base group for age_group is "18-24", base group for education is "Primary school"


all_results <- list()

for (i in 1:5) {
  # Filter for one narrative
  data_nar <- reg_data %>%
    filter(lfCB == i) %>%
    droplevels()  # Drop unused factor levels
  
  # Run logistic regression
  model <- glm(d_agree ~ male + age_group + educ + urban,
               data = data_nar, family = "binomial")
  
  # Get marginal effects
  marginal <- margins(model)
  summary_marginal <- summary(marginal)
  
  # Format result
  formatted <- summary_marginal %>%
    as_tibble() %>%
    mutate(
      marginal_effect = scales::percent(AME, accuracy = 0.1),
      p_value = ifelse(p < 0.001, "<0.001", format(round(p, 3), nsmall = 3)),
      significance = case_when(
        p < 0.001 ~ "***",
        p < 0.01 ~ "**",
        p < 0.05 ~ "*",
        p < 0.1 ~ ".",
        TRUE ~ ""
      ),
      narrative = i
    ) %>%
    select(narrative, factor, AME, p_value, significance)
  
  all_results[[i]] <- formatted
}

# Combine all into one table
final_table <- bind_rows(all_results)


```

``` {r arc_kable_output_ame_agree}

# Format cell content as simple plain-text strings
formatted_table <- final_table %>%
  mutate(
    p_value_num = as.numeric(p_value),
    p_value_fmt = ifelse(
      is.na(p_value_num),
      as.character(p_value),
      sprintf("%.3f", p_value_num)
    ),
    cell = paste0(sprintf("%.3f", AME), " ", "(p = ", p_value_fmt, ")", significance)
  ) %>%
  select(narrative, factor, cell) %>%
  pivot_wider(names_from = narrative, values_from = cell, names_prefix = "Narrative ")

# Output simple PDF-friendly kable
kable_logit_agree <- formatted_table %>%
  rename(`Predictor` = factor) %>%
  kable(
    booktabs = TRUE,
    longtable = TRUE,
    escape = TRUE,
    caption = "Average Marginal Effects on Agreement to Stimulus"
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "repeat_header"),
    font_size = 6.5
  ) %>%
  column_spec(1, bold = TRUE)

```



``` {r arc_proportion_emotion}
## 4a) Test of two proportion for evoked emotion and agreement

cb02_data_all <- cb_data %>%
  select(record, d_correct, d_agree) %>%
  inner_join(cb02_data, by = "record")


results_df <- data.frame()

for (nar in 1:5) {
  for (i in 1:9) {
    emotion_col <- paste0("CB02", LETTERS[nar], "r", i)
    emotion_name <- emotion_list[as.character(i)]

    temp_table <- cb02_data_all %>%
      filter(lfCB == nar) %>%
      mutate(selected = !!sym(emotion_col) == 1) %>%
      group_by(d_agree, selected) %>%
      summarise(count = n(), .groups = "drop") %>%
      pivot_wider(names_from = selected, values_from = count, values_fill = 0)

    if (nrow(temp_table) == 2 && all(c("TRUE", "FALSE") %in% colnames(temp_table))) {
      x <- c(temp_table$`TRUE`[1], temp_table$`TRUE`[2])
      n <- rowSums(temp_table[, c("TRUE", "FALSE")])
      test <- prop.test(x = x, n = n)
      
      sig_star <- case_when(
        test$p.value <= 0.001 ~ "***",
        test$p.value <= 0.01  ~ "**",
        test$p.value <= 0.05  ~ "*",
        TRUE                  ~ ""
        )

      results_df <- rbind(results_df, data.frame(
        narrative = nar,
        emotion = emotion_name,
        agree_yes = x[2],
        agree_total = n[2],
        disagree_yes = x[1],
        disagree_total = n[1],
        p_value = round(test$p.value, 4),
        agree_prop = round(test$estimate[2], 3),
        disagree_prop = round(test$estimate[1], 3),
        significance = sig_star
      ))
    }
  }
}

```

``` {r arc_kable_proportion_test}

narrative_tables <- results_df %>%
  arrange(narrative, emotion) %>%
  group_split(narrative)

kable_outputs <- list() # Create an empty list to store the kable outputs

for (i in 1:5) {
  caption_kable <- paste0("Emotion differences of agree and disagree groups \n(Narrative ", i, ")")
  kable_name <- paste0("kable_", i)
  
  table_data <- narrative_tables[[i]] %>%
    mutate(
      agree_prop = scales::percent(agree_prop, accuracy = 1),
      disagree_prop = scales::percent(disagree_prop, accuracy = 1),
      p_value = ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value))
    ) %>%
    select(emotion, agree_prop, disagree_prop, p_value, significance)

  kable_outputs[[i]] <- kable(
    table_data,
    caption = caption_kable,
    col.names = c("Emotion", "Agree (%)", "Disagree (%)", "P-value", "Sig"),
    align = c("l", "r", "r", "r", "c")
  ) %>%
    kable_styling(font_size = 10, full_width = FALSE) %>%
    column_spec(1, width = "8em") %>%
    column_spec(2:4, width = "6em") %>%
    column_spec(5, width = "3em")
}
```

``` {r arc_print_kable, results='asis'}
#print(kable_outputs[1])
#cat("\\newpage\n")

#for (i in 2:4) {
#  print(kable_outputs[[i]])
#  cat("\n") # Add a newline for spacing
#}

#cat("\\newpage\n")
#print(kable_outputs[5])
```


